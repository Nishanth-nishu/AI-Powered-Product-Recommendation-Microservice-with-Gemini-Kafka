<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõçÔ∏è AI Recommendation Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .product-card { transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .cart-badge { animation: bounce 0.5s; }
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-600">
                        <i class="fas fa-shopping-bag mr-2"></i>
                        AI Store
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search products..." 
                            class="px-4 py-2 border rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="searchProducts()" class="absolute right-2 top-2 text-gray-500">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <button onclick="toggleCart()" class="text-gray-700 hover:text-indigo-600 relative">
                            <i class="fas fa-shopping-cart text-2xl"></i>
                            <span id="cartCount" class="cart-badge absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">0</span>
                        </button>
                    </div>
                    <span id="userGreeting" class="text-gray-600 font-medium"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Categories -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Shop by Category</h2>
            <div id="categories" class="flex overflow-x-auto space-x-4 pb-4">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- Personalized Recommendations -->
        <div id="recommendationsSection" class="mb-8 hidden">
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg p-6 mb-4">
                <h2 class="text-2xl font-bold mb-2">
                    <i class="fas fa-magic mr-2"></i>
                    Recommended For You
                </h2>
                <p class="opacity-90">AI-powered personalized product suggestions</p>
            </div>
            <div id="recommendations" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <!-- Recommendations will be loaded here -->
            </div>
        </div>

        <!-- Products Grid -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">All Products</h2>
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Shopping Cart Sidebar -->
    <div id="cartSidebar" class="fixed right-0 top-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex flex-col h-full">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Shopping Cart</h2>
                    <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <div id="cartItems" class="flex-1 overflow-y-auto p-4">
                <!-- Cart items will be loaded here -->
            </div>
            <div class="border-t p-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-semibold">Total:</span>
                    <span id="cartTotal" class="text-2xl font-bold text-indigo-600">$0.00</span>
                </div>
                <button onclick="checkout()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-credit-card mr-2"></i>
                    Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-gray-700 font-medium">Loading...</p>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let userId = localStorage.getItem('userId') || `user_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('userId', userId);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('userGreeting').textContent = `üë§ ${userId}`;
            loadCategories();
            loadProducts();
            loadRecommendations();
            updateCartUI();
        });

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/api/v1/categories`);
                const data = await response.json();
                const container = document.getElementById('categories');
                
                data.categories.slice(0, 10).forEach(cat => {
                    const slug = typeof cat === 'string' ? cat : cat.slug;
                    const name = typeof cat === 'string' ? cat : cat.name;
                    
                    container.innerHTML += `
                        <button onclick="loadProductsByCategory('${slug}')" 
                            class="px-6 py-2 bg-white rounded-full shadow hover:shadow-md transition-shadow whitespace-nowrap">
                            ${name}
                        </button>
                    `;
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load products
        async function loadProducts(query = '', category = '') {
            showLoading();
            try {
                let url = `${API_URL}/api/v1/products/search?limit=12`;
                if (query) url += `&query=${query}`;
                if (category) url = `${API_URL}/api/v1/products/category/${category}?limit=12`;
                
                const response = await fetch(url);
                const data = await response.json();
                const products = data.products || [];
                
                displayProducts(products, 'productsGrid');
            } catch (error) {
                console.error('Error loading products:', error);
            } finally {
                hideLoading();
            }
        }

        // Load products by category
        async function loadProductsByCategory(category) {
            loadProducts('', category);
        }

        // Search products
        function searchProducts() {
            const query = document.getElementById('searchInput').value;
            if (query) loadProducts(query);
        }

        // Load recommendations
        async function loadRecommendations() {
            try {
                const response = await fetch(`${API_URL}/api/v1/recommendations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, limit: 5 })
                });
                const data = await response.json();
                
                if (data.recommendations && data.recommendations.length > 0) {
                    document.getElementById('recommendationsSection').classList.remove('hidden');
                    displayProducts(data.recommendations, 'recommendations', true);
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
            }
        }

        // Display products
        function displayProducts(products, containerId, isRecommendation = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            products.forEach(product => {
                const id = product.id || product.product_id;
                const price = parseFloat(product.price || 0);
                const priceINR = (price * 83).toFixed(2); // USD to INR conversion
                
                const card = `
                    <div class="product-card bg-white rounded-lg shadow-md overflow-hidden">
                        <img src="${product.thumbnail || 'https://via.placeholder.com/300'}" 
                            alt="${product.title}" 
                            class="w-full h-48 object-cover cursor-pointer"
                            onclick="viewProduct('${id}')">
                        <div class="p-4">
                            <h3 class="font-semibold text-gray-800 mb-2 truncate">${product.title}</h3>
                            <p class="text-gray-600 text-sm mb-2">${product.category || 'General'}</p>
                            ${isRecommendation && product.reason ? 
                                `<p class="text-xs text-indigo-600 mb-2"><i class="fas fa-magic"></i> ${product.reason}</p>` : ''}
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-bold text-indigo-600">‚Çπ${priceINR}</span>
                                <div class="flex space-x-2">
                                    <button onclick="viewProduct('${id}')" 
                                        class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 transition-colors">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="addToCart('${id}')" 
                                        class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors">
                                        <i class="fas fa-cart-plus"></i>
                                    </button>
                                </div>
                            </div>
                            ${product.rating ? 
                                `<div class="mt-2 text-yellow-500">${'‚≠ê'.repeat(Math.round(product.rating))}</div>` : ''}
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // View product (track interaction)
        async function viewProduct(productId) {
            await trackInteraction(productId, 'view');
            // Reload recommendations after interaction
            setTimeout(() => loadRecommendations(), 500);
        }

        // Add to cart
        async function addToCart(productId) {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/api/v1/products/${productId}`);
                const product = await response.json();
                
                const existingItem = cart.find(item => item.id == productId);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({...product, quantity: 1});
                }
                
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartUI();
                
                // Track interaction
                await trackInteraction(productId, 'add_to_cart');
                
                // Show success message
                showNotification('Added to cart!');
                
                // Reload recommendations
                setTimeout(() => loadRecommendations(), 500);
            } catch (error) {
                console.error('Error adding to cart:', error);
            } finally {
                hideLoading();
            }
        }

        // Track interaction
        async function trackInteraction(productId, type) {
            try {
                await fetch(`${API_URL}/api/v1/interactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        product_id: productId,
                        interaction_type: type
                    })
                });
            } catch (error) {
                console.error('Error tracking interaction:', error);
            }
        }

        // Update cart UI
        function updateCartUI() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = count;
            
            const cartItems = document.getElementById('cartItems');
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-center text-gray-500 py-8">Your cart is empty</p>';
            } else {
                cartItems.innerHTML = cart.map(item => {
                    const priceUSD = parseFloat(item.price || 0);
                    const priceINR = (priceUSD * 83).toFixed(2);
                    const itemTotal = (priceINR * item.quantity).toFixed(2);
                    
                    return `
                        <div class="flex items-center space-x-4 mb-4 pb-4 border-b">
                            <img src="${item.thumbnail}" alt="${item.title}" class="w-16 h-16 object-cover rounded">
                            <div class="flex-1">
                                <h4 class="font-semibold text-sm">${item.title}</h4>
                                <p class="text-indigo-600 font-bold">‚Çπ${priceINR} √ó ${item.quantity}</p>
                                <p class="text-gray-600 text-sm">Subtotal: ‚Çπ${itemTotal}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="updateQuantity(${item.id}, -1)" class="px-2 py-1 bg-gray-200 rounded">-</button>
                                <span class="font-semibold">${item.quantity}</span>
                                <button onclick="updateQuantity(${item.id}, 1)" class="px-2 py-1 bg-gray-200 rounded">+</button>
                            </div>
                            <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            const total = cart.reduce((sum, item) => {
                const priceINR = parseFloat(item.price || 0) * 83;
                return sum + (priceINR * item.quantity);
            }, 0);
            
            document.getElementById('cartTotal').textContent = `‚Çπ${total.toFixed(2)}`;
        }

        // Update quantity
        function updateQuantity(productId, change) {
            const item = cart.find(i => i.id == productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartUI();
                }
            }
        }

        // Remove from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id != productId);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
        }

        // Toggle cart
        function toggleCart() {
            const sidebar = document.getElementById('cartSidebar');
            sidebar.classList.toggle('translate-x-full');
        }

        // Checkout
        async function checkout() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            
            const total = cart.reduce((sum, item) => {
                const priceINR = parseFloat(item.price || 0) * 83;
                return sum + (priceINR * item.quantity);
            }, 0);
            
            // Track purchases
            for (const item of cart) {
                await trackInteraction(item.id, 'purchase');
            }
            
            alert(`Thank you for your purchase!\n\nTotal: ‚Çπ${total.toFixed(2)}\nItems: ${cart.reduce((sum, item) => sum + item.quantity, 0)}`);
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
            toggleCart();
            
            // Reload recommendations after purchase
            setTimeout(() => loadRecommendations(), 500);
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchProducts();
        });
    </script>
</body>
</html>